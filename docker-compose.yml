services:

  db:
    build:
      context: ./postgres
    container_name: easydoor-db
    restart: unless-stopped
    ports:
      - "5434:5432"
    env_file: .env
    volumes:
      - ./data:/var/lib/postgresql
      - ./postgres/config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./postgres_logs:/var/log/postgresql
    command: >
      postgres
        -c config_file=/etc/postgresql/postgresql.conf
        -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 10

  log_separator:
    image: python:3.11-slim
    container_name: easydoor-log-sep
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./postgres_logs:/var/log/postgresql:ro
      - ./audit_logs:/output
      - ./postgres/separate_logs_realtime.py:/app/separate_logs.py:ro
    command: >
      python /app/separate_logs.py /var/log/postgresql/postgresql.log
        --audit-log /output/audit.log
        --normal-log /output/postgres.log

  ed-backend-api:
    build:
      context: ../ed-backend-api
      dockerfile: ../ed-infra/backend/Dockerfile
    container_name: easydoor-backend-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://easydoor:easydoor@db:5432/easydoor
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://localhost:5174,http://localhost:5175}
      WORKER_API_KEY: ${WORKER_API_KEY}
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    depends_on:
      db:
        condition: service_healthy

  ed-worker:
    build:
      context: ../
      dockerfile: ed-infra/worker/Dockerfile
    container_name: easydoor-worker
    restart: unless-stopped
    shm_size: 2gb
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_ADMIN
    environment:
      API_URL: http://ed-backend-api:8000
      API_TOKEN: ${API_TOKEN:-}
      WORKER_API_KEY: ${WORKER_API_KEY}
      WORKER_MAX_TOTAL: "3"
      WORKER_HEADLESS: "1"
    depends_on:
      ed-backend-api:
        condition: service_healthy

  ed-geocoder:
    build:
      context: ../
      dockerfile: ed-infra/geocoder/Dockerfile
    container_name: easydoor-geocoder
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://easydoor:easydoor@db:5432/easydoor
      GEOCODER_POLL_INTERVAL: "30"
      GEOCODER_BATCH_SIZE: "50"
    depends_on:
      db:
        condition: service_healthy

  nginx:
    image: nginx:alpine
    container_name: easydoor-nginx
    restart: unless-stopped
    ports:
      - "4174:4174"
      - "4175:4175"
      - "4176:4176"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - ed-frontend-app
      - ed-admin
      - ed-calibrador
      - ed-backend-api

  ed-frontend-app:
    build:
      context: ../ed-frontend-app
      dockerfile: ../ed-infra/frontend/Dockerfile
      args:
        PORT: "4175"
    container_name: easydoor-frontend
    restart: unless-stopped
    environment:
      PORT: "4175"

  ed-admin:
    build:
      context: ../ed-admin
      dockerfile: ../ed-infra/frontend/Dockerfile
      args:
        PORT: "4176"
    container_name: easydoor-ed-admin
    restart: unless-stopped
    environment:
      PORT: "4176"

  ed-calibrador:
    build:
      context: ../ed-calibrador
      dockerfile: ../ed-infra/frontend/Dockerfile
      args:
        PORT: "4174"
    container_name: easydoor-ed-calibrador
    restart: unless-stopped
    environment:
      PORT: "4174"

